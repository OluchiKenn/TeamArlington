{% extends "base.html" %}
{% block content %}
<h2>Request #{{ d.id }} — {{ d.form_name }}</h2>

<div>
  <strong>State:</strong> {{ d.state }}
  {% if d.current_step.number %}| <strong>Step:</strong> {{ 
d.current_step.number }}{% endif %}
  {% if d.current_step.assignee %}| <strong>Assignee:</strong> {{ 
d.current_step.assignee }}{% endif %}
</div>
<div class="muted">Submitted: {{ d.submitted_at }} | Updated: {{ 
d.updated_at }}</div>

{% if view == 'approver' %}
  {% if has_pending_for_me %}
  <div style="margin: 16px 0; padding: 12px; border: 1px solid #ddd;">
    <h4>Actions</h4>
    <form method="post" action="{{ url_for('approvals_bp.approver_request_approve', request_id=d.id) }}" style="margin-bottom:8px;">
      <div>
        <label for="approve-comments">Comments (optional)</label>
        <textarea id="approve-comments" name="comments" rows="3" style="width:100%"></textarea>
      </div>
      <button type="submit">Approve</button>
    </form>
    <form method="post" action="{{ url_for('approvals_bp.approver_request_return', request_id=d.id) }}">
      <div>
        <label for="return-comments">Comments (optional)</label>
        <textarea id="return-comments" name="comments" rows="3" style="width:100%"></textarea>
      </div>
      <button type="submit">Return</button>
    </form>
  </div>
  {% else %}
  <p class="muted">Approver view</p>
  {% endif %}
{% else %}
  <p class="muted">Student view</p>
  {% if d.state == 'RETURNED' %}
    <p><a href="{{ url_for('approvals_bp.edit_request', request_id=d.id) }}">Resubmit</a></p>
  {% endif %}
{% endif %}

<h3>Fields</h3>
<table border="1" cellpadding="6" cellspacing="0">
  <tbody>
    {% for f in d.fields %}
    <tr><th>{{ f.label }}</th><td>{{ f.value }}</td></tr>
    {% endfor %}
  </tbody>
</table>

<h3>History</h3>
<ol>
  {% for e in d.history %}
  <li><strong>{{ e.event }}</strong> — {{ e.at }} <span class="muted">({{ 
e.by }})</span></li>
  {% endfor %}
</ol>

<h3>PDFs</h3>
<ul>
  {% if d.pdfs|length == 0 %}
    <li><em>No PDFs yet.</em></li>
  {% endif %}
  {% for p in d.pdfs %}
    <li><a href="{{ p.url }}" target="_blank" rel="noreferrer">{{ p.name 
}}</a>
        <span class="muted">— {{ p.stateAtGen }} (step {{ p.stepNumber 
}})</span></li>
  {% endfor %}
</ul>
{% endblock %}

